<!doctype html>
<head>
	<meta charset="utf-8">
	<title>Single Command</title>
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
</head>

<body>
    <h1>Welcome to Smoothie web interface</h1>

    <h2>Commands</h2>
	<form action="/command" id="commandForm">
		<input type="text" name="commandText" placeholder="Send Command...">
		<input type="submit" value="Send">
	</form>
	<!-- the result of the command will be rendered inside this div -->
	<div id="result"></div>
	<script>
		// Attach a submit handler to the form
		$( "#commandForm" ).submit(function( event ) {
			// Stop form from submitting normally
			event.preventDefault();
			// Get some values from elements on the page:
			var $form = $( this );
			command = $form.find( "input[name='commandText']" ).val();
			command += "\n";
			url = $form.attr( "action" );
			// Send the data using post
			var posting = $.post( url, command );
			// Put the results in a div
			posting.done(function( data ) {
				$( "#result" ).empty();
                $.each(data.split('\n'), function(index) {
                    $( "#result" ).append( this + '<br/>' );
                });
			});
		});
	</script>

	<h2> Upload File </h2>
	<input type="file" id="files" name="files[]" onchange="upload();" />

	<h3>Uploading file(s)</h3>
	<output id="list"></output>
    <div id="progress"></div>
    <div id="uploadresult"></div>
	<script>
	function handleFileSelect(evt) {
	    var files = evt.target.files; // handleFileSelectist object

	    // files is a FileList of File objects. List some properties.
	    var output = [];
	    for (var i = 0, f; f = files[i]; i++) {
	    	output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
	    		f.size, ' bytes, last modified: ',
	    		f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
	    		'</li>');
	    }
	    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);


	function upload() {
        // take the file from the input
        var file = document.getElementById('files').files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file); // alternatively you can use readAsDataURL
        reader.onloadend  = function(evt)
        {
            // create XHR instance
            xhr = new XMLHttpRequest();

            // send the file through POST
            xhr.open("POST", 'upload', true);
			xhr.setRequestHeader('X-Filename', file.name);

            // make sure we have the sendAsBinary method on all browsers
            XMLHttpRequest.prototype.mySendAsBinary = function(text){
                var data = new ArrayBuffer(text.length);
                var ui8a = new Uint8Array(data, 0);
                for (var i = 0; i < text.length; i++) ui8a[i] = (text.charCodeAt(i) & 0xff);

                if(typeof window.Blob == "function")
                {
                     var blob = new Blob([data]);
                }else{
                     var bb = new (window.MozBlobBuilder || window.WebKitBlobBuilder || window.BlobBuilder)();
                     bb.append(data);
                     var blob = bb.getBlob();
                }

                this.send(blob);
            }

            // let's track upload progress
            var eventSource = xhr.upload || xhr;
            eventSource.addEventListener("progress", function(e) {
                // get percentage of how much of the current file has been sent
                var position = e.position || e.loaded;
                var total = e.totalSize || e.total;
                var percentage = Math.round((position/total)*100);

                // here you should write your own code how you wish to proces this
                $( "#progress" ).empty().append('uploaded ' + percentage + '%');
            });

            // state change observer - we need to know when and if the file was successfully uploaded
            xhr.onreadystatechange = function()
            {
                if(xhr.readyState == 4)
                {
                    if(xhr.status == 200)
                    {
                        // process success
                        $( "#uploadresult" ).empty().append( 'Uploaded Ok');
                    }else{
                        // process error
                        $( "#uploadresult" ).empty().append( 'Uploaded Failed');
                    }
                }
            };

            // start sending
            xhr.mySendAsBinary(evt.target.result);
        };
	}
	</script>

</body>
</html>
